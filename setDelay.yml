-   name: "Change wiremock fixedDelay" 
    hosts: "all"
    gather_facts: False
    vars:    
      mockDelays: "{{ lookup('file','files/mockDelays.yml') | from_yaml }}"
    pre_tasks:
      - assert:  
          that: "{{ item }} is defined" 
          msg: "Variable {{ item }} must be provided"
        with_items: 
          - wiremock_mapping_home
    tasks:
        - name: "Extract unique list of mocks"  
          set_fact: 
            wiremock_mocks: "{{mockDelays | map(attribute='mockName') | join(',') }}"             

        - name: "Prepend to mocks a wiremock_mapping_home path"
          set_fact:
            folderList: "{{ folderList|default([]) + [ {'folderName': wiremock_mapping_home + '/' + item.mockName, 'delay': item.delay, 'fileMask': item.fileMask} ] }}"         
          with_items: "{{ mockDelays}}"  

        - name: "Find affected mock files"
          find:
            paths: "{{ item.folderName }}"
            patterns: "{{ item.fileMask }}*.json"
          with_items: "{{ folderList }}"
          register: fileList

        - name: "Prepare file list with delays"
          set_fact: 
            delayList: "{{ delayList|default([]) + [ {'fileName':  item.1.path, 'delay': folderList | selectattr('folderName', 'equalto', item.0.item.folderName) | map(attribute='delay') | join(',') } ] }}"                    
          with_subelements:
            - "{{ fileList.results }}"
            - files  

        - name: "Debug - list of files to be impacted"
          debug: 
            msg: "{{ delayList }}"
          when: delayList is defined

        - name: "Remove lines with occurrences of fixed delay"
          lineinfile:               
              path: "{{ item.fileName }}"
              regexp: '^.*"fixedDelayMilliseconds.*'
              state: absent
          with_items: "{{ delayList }}"
          when: delayList is defined
    
        - name: "Add fixed delay as per a new definition"
          lineinfile:
            path: "{{ item.fileName }}"
            insertafter: '^.*"status"'
            line: '"fixedDelayMilliseconds": {{item.delay}},'
            state: present
          with_items: "{{ delayList }}"  
          when: delayList is defined

        - name: "Check Wiremock java process"
          shell: "ps axf | grep 'java -jar wiremock' | grep -v grep | awk '{print $1}'"
          register: wiremock_pid
          ignore_errors: false

        - name: "Debug step - wiremock PID"
          debug: 
            msg="Wiremock process was running on {{ inventory_hostname }} with PID {{wiremock_pid.stdout}} "
          when: wiremock_pid.stdout_lines | length > 0

        - name: "Kill Wiremock java process"
          shell: "kill -9 {{ wiremock_pid.stdout }}"
          ignore_errors: false
          when: wiremock_pid.stdout_lines | length > 0

        - name: "Start Wiremock java process"
          shell: "./wiremock.sh -start -port {{ wiremock_port }} -mock {{ wiremock_mocks }}"
          args:
            chdir: "{{ wiremock_home }}"            
          ignore_errors: false
          register: wiremock_start_output
  
        - name: "Debug step - wiremock start output"
          debug: 
            msg="Wiremock process started {{ wiremock_start_output }} "  
#ansible-playbook setDelay.yml -i inventory --limit vagrant1 --extra-vars "wiremock_mapping_home='~/wiremock/mappings' wiremock_port='8080' wiremock_home='~/wiremock'"

# Todo
#---------------------------------------------------
# markdown for execution
# define in inventory -> wiremock_port, wiremock_home


