-   name: "Change fixedDelay" 
    hosts: "vagrant1"
    gather_facts: False
    vars:    
      mockList: "{{ lookup('file','files/mockDelays.yml') | from_yaml }}"
    pre_tasks:
      - assert:  
          that: "{{ item }} is defined" 
          msg: "Variable {{ item }} must be provided"
        with_items: 
          - baseDir
          - mockList
    tasks:
        - name: "Prepend to mocks a basedir path"
          set_fact:
            folderList: "{{ folderList|default([]) + [ {'folderName': baseDir + '/' + item.mockName, 'delay': item.delay, 'fileMask': item.fileMask} ] }}"         
          with_items: "{{ mockList}}"  

        - name: "Debug step - folderList"
          debug: 
            msg="folderList {{ folderList}}"

        - name: "Find affected mock files"
          find:
            paths: "{{ item.folderName }}"
            patterns: "{{ item.fileMask }}*.json"
          with_items: "{{ folderList }}"
          register: fileList


        #- name: "Debug step - fileList"
        #  debug: 
        #    msg: "{{ fileList }}"

        - name: "Debug step - fileList"
          debug: 
            msg: "file: {{ item.1.path }}, delay: {{ folderList | selectattr('folderName', 'equalto', item.0.item.folderName) | map(attribute='delay') | join(',') }}"
          # nested lists require the following loop  
          with_subelements:
            - "{{ fileList.results }}"
            - files  


        - name: "Prepare file list with delays"
          set_fact: 
            delayList: "{{ delayList|default([]) + [ {'fileName':  item.1.path, 'delay': folderList | selectattr('folderName', 'equalto', item.0.item.folderName) | map(attribute='delay') | join(',') } ] }}"                    
          with_subelements:
            - "{{ fileList.results }}"
            - files  


        - name: "Debug step - delayList"
          debug: 
            msg: "{{ delayList }}"

        - name: "Remove lines with occurrences of fixed delay"
          lineinfile:               
              path: "{{ item.fileName }}"
              regexp: '^.*"fixedDelayMilliseconds.*'
              state: absent
          with_items: "{{ delayList }}"
    
        - name: "Add fixed delay"
          lineinfile:
            path: "{{ item.fileName }}"
            insertafter: '^.*"status"'
            line: ',"fixedDelayMilliseconds": {{item.delay}}'
            state: present
          with_items: "{{ delayList }}"  

        - name: "Check Wiremock java process"
          shell: "ps axf | grep 'java -jar wiremock' | grep -v grep | awk '{print $1}'"
          register: wiremock_pid
          ignore_errors: false

        - name: "Debug step"
          debug: 
            msg="Wiremock Process is running on {{ inventory_hostname }} ... {{wiremock_pid.stdout}} "
          when: wiremock_pid.stdout_lines|length > 0

        - name: "Kill Wiremock java process"
          shell: "kill -9 {{ wiremock_pid.stdout }}"
          ignore_errors: false
          when: wiremock_pid.stdout_lines|length > 0

        #- name: "Start Wiremock java process"
        #  shell: "java -jar wiremock...{{ mocks }}"
        #  ignore_errors: false
  
#ansible-playbook setDelay.yml -i inventory --limit vagrant1 -extra-vars "baseDir='~'"


